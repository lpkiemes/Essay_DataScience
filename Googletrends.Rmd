---
title: "Data Science, Computational Social Science, Big Data:" 
subtitle: "Programmieren für Sozialwissenschaftler_innen"
author: "Laura Kiemes 12250912 & Felix Grams 12293142"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: 1
  word_document:
    toc: yes
    toc_depth: 1
toc-title: Inhalt
---
R version 4.2.0 (2022-04-22)  
Platform: x86_64-apple-darwin17.0 (64-bit)  
Running under: macOS Monterey 12.4

# Pakete und Ordner
Zunächst wird das Pacman Paket installiert, falls dies noch nicht installiert wurde. Als nächstes wird dieses zusätzlich geladen. Über Pacman werden anschließend alle verwendeten Pakete installiert, falls dies noch nicht geschehen ist und ansonsten geladen.  
Die Ordner Plots und Tables werden erstellt. Das Referenzdatum wird festgelegt.
```{r packages verwenden und ordner erstellen, message=FALSE, warning=FALSE}
here::i_am("Googletrends.Rmd")

# Falls pacman nicht installiert ist wird es installiert und geladen
if (!require("pacman")) install.packages("pacman"); library(pacman)

# Falls pakete nicht installiert sind werden sie installiert und Pakete werden geladen
pacman::p_load(tidyverse, gtrendsR, ggsci, maps, rtweet, patchwork, lubridate, scales) 

dir.create("plots")
dir.create("tables")

date_analysis <- ymd("2022-07-01")
```

```{r farben locuszoom}
show_col(pal_locuszoom("default")(5))
colors_locuszoom <- c("#D43F3AFF", "#EEA236FF", "#5CB85CFF", "#46B8DAFF", "#357EBDFF")
names(colors_locuszoom) <- c("java", "javascript", "matlab", "php", "python")

show_col(pal_locuszoom("default", alpha = 0.5)(5))
colors_locuszoom_light <- c("#D43F3A7F", "#EEA2367F", "#5CB85C7F", "#46B8DA7F", "#357EBD7F")
names(colors_locuszoom_light) <- c("Java", "Javascript", "Matlab", "PHP", "Python")
```
# Gtrends
Zunächst werden Variationen für die Gtrends-Abfrage angelegt.
```{r Variationen definieren}
data("countries") # Datensatz zu Laenderbezeichnungen
countries$country_code[which(countries$name == "GERMANY")] # Abkuerzung fuer Deutschland
keywords_5 <- data.frame(
  languages = c("python", "matlab", "java", "php", "javascript")) # Schlusselworte Sprachen
geos <- c("DE", "") # interessierende Laender
times <- c("2004-07-01 2022-07-01", # 18 Jahre
           "2017-07-01 2022-07-01", # 5 Jahre
           "2021-07-01 2022-07-01") # 1 Jahr
list_data <- list() # leere Liste zum Fuellen mit Datensaetzen
list_plots <- list() # leeere Liste zum Fuellen mit Plots
```
Dann iterieren wir und speichern die erzeugten Objekte als csv Dateien und in einem Listenobjekt.
```{r for loop Daten}
i <- 0 # Index zum Mitlaufen

for (k in keywords_5) {
  for (t in times) {
    for (g in geos) {
      
      i <- i + 1 # Indexzaehler
      print(paste(i, t, g, k)) # Iteration anzeigen
      
      list_data[[i]] <- gtrends(
        keyword = k,
        geo = g,
        time = t,
        gprop = "web",
        category = 0,
        hl = "en-US",
        compared_breakdown = TRUE,
        low_search_volume = FALSE,
        cookie_url = "http://trends.google.com/Cookies/NID",
        tz = 0,
        onlyInterest = FALSE
      )
      
      write_csv(as.data.frame( # Tabellen erstellen
        list_data[[i]][["interest_over_time"]]), 
        file = here::here("tables", paste0("table_", i, ".csv")))

    }
  }
}

names(list_data) <- c("prog_all_de", "prog_all_int", 
                      "prog_5y_de", "prog_5y_int", 
                      "prog_12_de", "prog_12m_int")
```
# Plots
Anschließend iterieren wir über die erzeugten Listen mit den Datensätzen und erstellen jeweils einen Plot pro Datensatz.
```{r for loop Plots}
for (i in 1:length(list_data)) {

      list_plots[[i]] <- ggplot(
        data = list_data[[i]][["interest_over_time"]],
        aes(x = as.Date(date),
            y = hits,
            group = factor(keyword),
            color = keyword)) +
        geom_line(size = 1) +
        labs(
          x = "Zeit",
          y = "normalisierte, skalierte Aufrufe",
          color = "Suchbegriff", 
          caption = paste0("Datenquelle: Google Trends 
          (https://www.google.com/trends, abgefragt am ", date_analysis, ").")
          ) +
        theme_bw() +
        theme(
          axis.text.x = element_text(angle = 35, hjust = 1),
          plot.caption = element_text(size = 6, color = "gray60"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 8),
          legend.position = "bottom") +
        scale_x_date(date_labels = "%Y",
                     date_breaks = "2 years",
                     date_minor_breaks = "1 year") +
        scale_y_continuous(labels = scales::percent_format(scale = 1)) +
        ggsci::scale_colour_locuszoom()
      
      print(last_plot()) # anzeigen lassen
      
}

names(list_plots) <- c("prog_all_de", "prog_all_int", 
                      "prog_5y_de", "prog_5y_int", 
                      "prog_12_de", "prog_12m_int")
```
Für die erstellten Plots fügen wir als nächstes jeweilis Titel und Untertitel als Vektor bereit und ordnen diese innerhalb einer Schleife basierend auf den Index zu. 
```{r for loop plot names}
indice_5 <- c(3, 4)
indice_12 <- c(5, 6)

titles <- c(
  "Suchanfragen zu Programmiersprachen in Deutschland",
  "Suchanfragen zu Programmiersprachen weltweit",
  "Suchanfragen zu Programmiersprachen in Deutschland",
  "Suchanfragen zu Programmiersprachen weltweit",
  "Suchanfragen zu Programmiersprachen in Deutschland",
  "Suchanfragen zu Programmiersprachen weltweit"
)

subtitles <- c(
  "seit 2004",
  "seit 2004",
  "innerhalb der letzten fünf Jahre",
  "innerhalb der letzten fünf Jahre",
  "innerhalb der letzten 12 Monate",
  "innerhalb der letzten 12 Monate"
)

for (n in 1:length(list_data)) {
  list_plots[[n]] <- list_plots[[n]] + labs(title = titles[[n]], subtitle = subtitles[[n]])
  
  if (n %in% indice_5) { # falls innerhalb der letzten 5 Jahre
    list_plots[[n]] <- list_plots[[n]] + scale_x_date(date_labels = "%Y",
                                                      date_breaks = "1 years",
                                                      date_minor_breaks = "1 months")
  } else if (n %in% indice_12) { # falls innerhalb der letzten 12 monate
    list_plots[[n]] <- list_plots[[n]] + scale_x_date(date_labels = "%B %Y",
                                                      date_breaks = "1 months")
  }

  ggsave(filename = paste0("plot_", n, ".pdf"), 
         plot = list_plots[[n]], 
         width = 9, height = 5, 
         path = here::here("plots"))
  
  ggsave(filename = paste0("small_plot_", n, ".pdf"), 
         plot = list_plots[[n]], 
         width = 6, 
         height = 6, 
         path = here::here("plots"))

  write_csv(as.data.frame(
    list_data[[1]][["interest_over_time"]]), 
    file = here::here("tables", paste0("table_time_", n, ".csv")))
}
```

```{r weltdaten}
world <- map_data("world") # Weltdaten einlesen

# aendert die Regionnamen zu denen, die Google Trends verwendet 
world <- world %>%
  mutate(region = replace(region, region=="USA", "United States")) %>%
  mutate(region = replace(region, region=="UK", "United Kingdom"))
```

```{r}
data_time_names <- c(2, 4, 6)
list_data_time_names <- list()

for (d in 1:length(data_time_names)) {

  list_data_time_names[[d]] <- list_data[[data_time_names[d]]][["interest_by_country"]] %>%
  filter(location %in% world$region, hits > 0) %>%
  mutate(region = location, 
         hits = as.numeric(str_remove_all(hits, "%"))) %>%
  select(hits, keyword, region) %>%
  group_by(region) %>%
  arrange(region, desc(hits)) %>%
  slice(1)
  
}
```


```{r}
list_plot_time_names <- list()
names(times) <- c("18", "5", "1")

for (e in 1:length(list_data_time_names)) {
  
list_plot_time_names[[e]] <- ggplot() +
  geom_map(data = world,
           map = world,
           aes(x = long, y = lat, map_id = region),
           fill="#e5e5e5", color="#bababa", size=0.15) +
  geom_map(data = list_data_time_names[[e]], 
           map = world, 
           aes(fill = keyword, map_id = region, alpha = hits)) +
  ggtitle("Suchanfragen zu Programmiersprachen weltweit seit Juli 2004*") +
  theme_void() +
  labs(fill = "Suchwort",
       alpha = "Prozentzahl der 
       Suchanfragen",
       caption = paste0("*Regionen mit geringem Suchvolumen grau hinterlegt
       
       Datenquelle: Google Trends 
          (https://www.google.com/trends, abgefragt am ", date_analysis, ").")) +
  scale_fill_manual(values = c(colors_locuszoom["java"], colors_locuszoom["php"], colors_locuszoom["python"]))
  
  print(last_plot())
  
  ggsave(filename = paste0("plot_map_all_", names(times)[[e]], ".pdf"), 
         plot = list_plot_time_names[[e]], 
         width = 9, height = 5, 
         path = here::here("plots"))
}
```

```{r daten fuer karten nach einzelnen suchbegriffen}
python_data <- gtrends(keyword = "python", geo = "", time = times[3])
php_data <- gtrends(keyword = "php", geo = "", time = times[3])
matlab_data <- gtrends(keyword = "matlab", geo = "", time = times[3])
java_data <- gtrends(keyword = "java", geo = "", time = times[3])
javascript_data <- gtrends(keyword = "javascript", geo = "", time = times[3])

list_google_data <- list(java_data, javascript_data, matlab_data, php_data, python_data)
list_google_plots <- list()
```

```{r karten nach einzelnen suchbegriffen}
for (l in 1:length(list_tweet_data)) {
  
list_google_plots[[l]] <- ggplot() +
  geom_map(data = world,
           map = world,
           aes(x = long, y = lat, map_id = region),
           fill="#e5e5e5", color="#bababa", size=0.15) +
  geom_map(data = list_google_data[[l]][["interest_by_country"]] %>%
  filter(location %in% world$region, hits > 0) %>%
  mutate(region = location, 
         hits = as.numeric(str_remove_all(hits, "%"))), 
           map = world, 
           aes(fill = hits, map_id = region)) +
  ggtitle(paste("Suchanfragen zu", names(colors_locuszoom_light)[l], "weltweit seit Juli 2021*")) +
  theme_void() +
  labs(fill = "Anzahl",
       caption = paste0("*Regionen mit geringem Suchvolumen grau hinterlegt
       
       Datenquelle: Google Trends 
          (https://www.google.com/trends, abgefragt am ", date_analysis, ").")) +
  theme(plot.caption = element_text(size = 6, color = "gray60")) +
  scale_fill_continuous(high = colors_locuszoom[l], low = colors_locuszoom_light[l])
  
  print(last_plot())
  
  ggsave(filename = paste0("plot_map_", names(colors_locuszoom_light)[l], ".pdf"), 
         plot = list_google_plots[[l]], 
         width = 9, height = 5, 
         path = here::here("plots"))
}
```

